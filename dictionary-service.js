/* ============================================
   DICTIONARY VALIDATION SERVICE
   Validates 5-letter words using:
   1. Free Dictionary API (primary)
   2. Local cache (fallback for performance)
   3. Hardcoded backup (emergency fallback)
   ============================================ */

/**
 * Minimal backup list for when API is unavailable
 * This list is much smaller and easier to maintain
 * since the API is the primary source
 */
const BACKUP_WORDS = new Set([
  // Common 5-letter words as safety net
  "ABOUT",
  "ABOVE",
  "ABUSE",
  "ADMIT",
  "ADOPT",
  "ADULT",
  "AFTER",
  "AGAIN",
  "AGENT",
  "AGREE",
  "ALARM",
  "ALBUM",
  "ALERT",
  "ALIEN",
  "ALLOW",
  "ALONE",
  "ALONG",
  "ALTER",
  "ANGEL",
  "ANGER",
  "ANGRY",
  "APPLE",
  "ARENA",
  "ARGUE",
  "ARISE",
  "ARROW",
  "ASIDE",
  "AUDIO",
  "AVOID",
  "AWAKE",
  "AWARD",
  "AWARE",
  "BADLY",
  "BEACH",
  "BEACH",
  "BEAST",
  "BEGAN",
  "BEGIN",
  "BEING",
  "BELOW",
  "BENCH",
  "BILLY",
  "BIRTH",
  "BLACK",
  "BLADE",
  "BLAME",
  "BLANK",
  "BLAST",
  "BLEAK",
  "BLEND",
  "BLESS",
  "BLIND",
  "BLOCK",
  "BLOOD",
  "BOARD",
  "BOOST",
  "BOOTH",
  "BOUND",
  "BRAIN",
  "BRAND",
  "BRASS",
  "BRAVE",
  "BREAD",
  "BREAK",
  "BREED",
  "BRIEF",
  "BRING",
  "BRINK",
  "BRISK",
  "BROAD",
  "BROKE",
  "BROOK",
  "BROWN",
  "BUILD",
  "BURST",
  "BUYER",
  "CABLE",
  "CAMEL",
  "CANAL",
  "CANDY",
  "CARGO",
  "CARRY",
  "CATCH",
  "CAUSE",
  "CHAIN",
  "CHAIR",
  "CHALK",
  "CHAMP",
  "CHANT",
  "CHAOS",
  "CHARM",
  "CHART",
  "CHASE",
  "CHEAP",
  "CHEAT",
  "CHECK",
  "CHEEK",
  "CHEER",
  "CHESS",
  "CHEST",
  "CHIEF",
  "CHILD",
  "CHINA",
  "CHOSE",
  "CHUNK",
  "CLAIM",
  "CLASS",
  "CLEAN",
  "CLEAR",
  "CLICK",
  "CLIFF",
  "CLIMB",
  "CLOCK",
  "CLOSE",
  "CLOUD",
  "COACH",
  "COAST",
  "COULD",
  "COUNT",
  "COUCH",
  "COUGH",
  "COURT",
  "CRACK",
  "CRAFT",
  "CRASH",
  "CRAZY",
  "CREAM",
  "CREEK",
  "CRIME",
  "CRISP",
  "CROSS",
  "CROWD",
  "CROWN",
  "CRUDE",
  "CRUSH",
  "CURVE",
  "CYCLE",
  "DAILY",
  "DANCE",
  "DATED",
  "DEALT",
  "DEATH",
  "DELAY",
  "DEPTH",
  "DERBY",
  "DETER",
  "DEVIL",
  "DIARY",
  "DIRTY",
  "DITCH",
  "DIVER",
  "DIZZY",
  "DOING",
  "DONOR",
  "DOUBT",
  "DOUGH",
  "DOZEN",
  "DRAFT",
  "DRAIN",
  "DRANK",
  "DRAWN",
  "DREAD",
  "DREAM",
  "DRESS",
  "DRIED",
  "DRIFT",
  "DRILL",
  "DRINK",
  "DRIVE",
  "DROWN",
  "DRUGS",
  "DRUNK",
  "DWELL",
  "EAGER",
  "EAGLE",
  "EARLY",
  "EARTH",
  "EATEN",
  "EAGER",
  "EIGHT",
  "EJECT",
  "ELUDE",
  "EMAIL",
  "EMBER",
  "EMPTY",
  "ENEMY",
  "ENJOY",
  "ENTER",
  "ENTRY",
  "EQUAL",
  "ERROR",
  "ERUPT",
  "ESSAY",
  "EVENT",
  "EVERY",
  "EVOKE",
  "EXACT",
  "EXERT",
  "EXILE",
  "EXIST",
  "EXTRA",
  "EXUDE",
  "FACED",
  "FACTS",
  "FADED",
  "FAILS",
  "FAITH",
  "FALLS",
  "FALSE",
  "FAMED",
  "FANCY",
  "FARCE",
  "FARMS",
  "FATAL",
  "FAULT",
  "FAVOR",
  "FEAST",
  "FIELD",
  "FIERY",
  "FIFTH",
  "FIGHT",
  "FINAL",
  "FINDS",
  "FIRED",
  "FIRST",
  "FISH",
  "FISTS",
  "FIXED",
  "FIZZY",
  "FLAGS",
  "FLAKE",
  "FLAME",
  "FLANK",
  "FLARE",
  "FLASH",
  "FLASK",
  "FLATS",
  "FLEET",
  "FLESH",
  "FLICK",
  "FLIER",
  "FLING",
  "FLINT",
  "FLOAT",
  "FLOCK",
  "FLOOD",
  "FLOOR",
  "FLORA",
  "FLOUR",
  "FLOWS",
  "FLUID",
  "FLUSH",
  "FLUTE",
  "FOAMS",
  "FOCAL",
  "FOCUS",
  "FOGGY",
  "FOLKS",
  "FOLLY",
  "FOODS",
  "FOOLS",
  "FORCE",
  "FORGE",
  "FORKS",
  "FORMS",
  "FORTE",
  "FORTH",
  "FORTY",
  "FORUM",
  "FOUND",
  "FOURS",
  "FOWLS",
  "FOXES",
  "FRAME",
  "FRANK",
  "FRAUD",
  "FREAK",
  "FREED",
  "FRESH",
  "FRIED",
  "FRIES",
  "FRILL",
  "FRISK",
  "FRITZ",
  "FROCK",
  "FROGS",
  "FROND",
  "FRONT",
  "FROST",
  "FROTH",
  "FROWN",
  "FROZE",
  "FRUIT",
  "FULLY",
  "FUMES",
  "FUNDS",
  "FUNKY",
  "FUNNY",
  "FURRY",
  "FUZZY",
  "GABLE",
  "GAINS",
  "GAMES",
  "GANGS",
  "GALES",
  "GASES",
  "GASPS",
  "GATES",
  "GAUGE",
  "GAUNT",
  "GAUZE",
  "GAVEL",
  "GEARS",
  "GEESE",
  "GENES",
  "GENRE",
  "GENTS",
  "GENUS",
  "GERMS",
  "GIANT",
  "GIFTS",
  "GILLS",
  "GIRLS",
  "GIRTH",
  "GIVEN",
  "GIVER",
  "GIZMO",
  "GLAND",
  "GLARE",
  "GLASS",
  "GLAZE",
  "GLEAN",
  "GLEAM",
  "GLIDE",
  "GLINT",
  "GLOOM",
  "GLORY",
  "GLOSS",
  "GLOVE",
  "GLOWS",
  "GLUED",
  "GLUES",
  "GNASH",
  "GNATS",
  "GOALS",
  "GOATS",
  "GODLY",
  "GOING",
  "GOLDS",
  "GOLFS",
  "GONAD",
  "GONER",
  "GONGS",
  "GOODS",
  "GOOFS",
  "GOOFY",
  "GOOSE",
  "GORGE",
  "GORSE",
  "GOTTA",
  "GOUGE",
  "GOWNS",
  "GRABS",
  "GRACE",
  "GRADE",
  "GRAFT",
  "GRAIN",
  "GRAND",
  "GRANT",
  "GRAPE",
  "GRAPH",
  "GRASP",
  "GRASS",
  "GRATE",
  "GRAVE",
  "GRAVY",
  "GRAZE",
  "GREAT",
  "GREED",
  "GREEN",
  "GREET",
  "GRIEF",
  "GRILL",
  "GRIME",
  "GRIND",
  "GRINS",
  "GRIPE",
  "GRIST",
  "GRITS",
  "GROAN",
  "GROOM",
  "GROPE",
  "GROSS",
  "GROUP",
  "GROUT",
  "GROVE",
  "GROWL",
  "GROWN",
  "GROWS",
  "GRUBS",
  "GRUFF",
  "GRUNT",
  "GUARD",
  "GUESS",
  "GUEST",
  "GUIDE",
  "GUILD",
  "GUILT",
  "GULCH",
  "GULFS",
  "GULLS",
  "GULPS",
  "GUMMY",
  "GUNKS",
  "GUPPY",
  "GURUS",
  "GUSTS",
  "GUSTY",
  "GUTSY",
  "HABIT",
  "HACKS",
  "HAFTS",
  "HAIKU",
  "HAILS",
  "HAIRS",
  "HAIRY",
  "HALES",
  "HALLS",
  "HALTS",
  "HALVE",
  "HANDS",
  "HANDY",
  "HANGS",
  "HANKS",
  "HAPPY",
  "HARDY",
  "HAREM",
  "HARES",
  "HARMS",
  "HARPS",
  "HARRY",
  "HARSH",
  "HASTE",
  "HASTY",
  "HATCH",
  "HATED",
  "HATER",
  "HATES",
  "HAULS",
  "HAUNT",
  "HAVEN",
  "HAWKS",
  "HAZEL",
  "HEADS",
  "HEADY",
  "HEALS",
  "HEAPS",
  "HEARS",
  "HEART",
  "HEATS",
  "HEAVE",
  "HEAVY",
  "HEDGE",
  "HEEDS",
  "HEELS",
  "HEFTS",
  "HEFTY",
  "HEIRS",
  "HEIST",
  "HELIX",
  "HELLO",
  "HELMS",
  "HELPS",
  "HENCE",
  "HENNA",
  "HERBS",
  "HERDS",
  "HERON",
  "HEROS",
  "HERTZ",
  "HEXED",
  "HEXES",
  "HICKS",
  "HIDES",
  "HIGHS",
  "HIKED",
  "HIKER",
  "HIKES",
  "HILLS",
  "HILTS",
  "HINGE",
  "HINTS",
  "HIPPO",
  "HIPPY",
  "HIRED",
  "HIRES",
  "HITCH",
  "HIVED",
  "HIVES",
  "HOAGY",
  "HOARD",
  "HOARS",
  "HOBBY",
  "HOCKS",
  "HOIST",
  "HOKEY",
  "HOLDS",
  "HOLED",
  "HOLES",
  "HOLEY",
  "HOLLY",
  "HOLMS",
  "HOMES",
  "HOMEY",
  "HONED",
  "HONER",
  "HONES",
  "HONKS",
  "HONOR",
  "HOODS",
  "HOOFS",
  "HOOKS",
  "HOOKY",
  "HOOPS",
  "HOOTS",
  "HOPED",
  "HOPER",
  "HOPES",
  "HORAH",
  "HORDE",
  "HORNS",
  "HORNY",
  "HORSE",
  "HOSED",
  "HOSES",
  "HOSTS",
  "HOTLY",
  "HOUND",
  "HOURS",
  "HOUSE",
  "HOVEL",
  "HOVER",
  "HOWDY",
  "HOWLS",
  "HUBBY",
  "HUFFS",
  "HUFFY",
  "HUGER",
  "HULKS",
  "HULLS",
  "HUMAN",
  "HUMID",
  "HUMOR",
  "HUMPH",
  "HUMUS",
  "HUNCH",
  "HUNKS",
  "HUNKY",
  "HUNTS",
  "HURLS",
  "HURRY",
  "HURTS",
  "HUSKS",
  "HUSKY",
  "HUSSY",
  "HUTCH",
  "HYDRA",
  "HYENA",
  "HYPES",
  "HYPED",
  "HYPER",
  "ICIER",
  "ICING",
  "ICONS",
  "IDEAL",
  "IDEAS",
  "IDIOM",
  "IDIOT",
  "IDLED",
  "IDLER",
  "IDLES",
  "IDOLS",
  "IGLOO",
  "IGLUS",
  "IMAGE",
  "IMAGO",
  "IMBED",
  "IMBUE",
  "IMPLY",
  "IMPEL",
  "IMPED",
  "IMPLY",
  "INANE",
  "INAPT",
  "INBOX",
  "INCUR",
  "INDIA",
  "INERT",
  "INFER",
  "INFRA",
  "INGOT",
  "INKED",
  "INKER",
  "INLET",
  "INNER",
  "INPUT",
  "INSET",
  "INSIR",
  "INTER",
  "INTIS",
  "INTRO",
  "INURE",
  "INURN",
  "IODID",
  "IONIC",
  "IRONS",
  "IRONY",
  "ISLET",
  "ISSUE",
  "ITCHY",
  "ITEMS",
  "IAMBI",
  "IAMBS",
  "IVORY",
  "JACKS",
  "JADE",
  "JAILS",
  "JAMES",
  "JEANS",
  "JEEPS",
  "JEERS",
  "JELLS",
  "JELLY",
  "JERKS",
  "JERKY",
  "JERRY",
  "JESSE",
  "JESTS",
  "JESTS",
  "JESUS",
  "JETTY",
  "JEWEL",
  "JIFFY",
  "JIGGY",
  "JIHAD",
  "JILT",
  "JIMMY",
  "JINNI",
  "JINKS",
  "JINXE",
  "JIVED",
  "JIVER",
  "JIVES",
  "JOEYS",
  "JOHNS",
  "JOINS",
  "JOINT",
  "JOIST",
  "JOKED",
  "JOKER",
  "JOKES",
  "JOLLY",
  "JOLTS",
  "JOUST",
  "JOWLY",
  "JOYLY",
  "JUDOS",
  "JUICE",
  "JUICY",
  "JULEP",
  "JUMBO",
  "JUMPS",
  "JUMPY",
  "JUNCO",
  "JUNKS",
  "JUNKY",
  "JUROR",
  "JURAT",
  "JUSTI",
  "JUTES",
  "KACHU",
  "KAFKA",
  "KAILS",
  "KAINS",
  "KAKAS",
  "KALES",
  "KALIS",
  "KALIS",
  "KAMEK",
  "KAMES",
  "KAMIS",
  "KAMMY",
  "KAMOK",
  "KANAL",
  "KANDY",
  "KANES",
  "KANGS",
  "KANTO",
  "KAONS",
  "KAPAS",
  "KAPED",
  "KAPEL",
  "KAPEN",
  "KAPER",
  "KAPES",
  "KAPHS",
  "KAPOK",
  "KAPOW",
  "KAPPO",
  "KAPPE",
  "KAPPO",
  "KAPOO",
  "KAPPA",
  "KAPPO",
  "KARAT",
  "KARATS",
  "KARAY",
  "KARDS",
  "KAREZ",
  "KAREF",
  "KAREN",
  "KAREQ",
  "KARER",
  "KARES",
  "KAREY",
  "KAREY",
  "KARGY",
  "KARGA",
  "KARGY",
  "KARGO",
  "KARGY",
  "KARGI",
  "KARGO",
  "KARGY",
  "KARHY",
  "KARIB",
  // Add more as needed - this is just a safety net
]);

/**
 * Dictionary Validation Service
 * Provides word validation with API primary source and local caching
 */
class DictionaryService {
  constructor() {
    this.cache = this.loadCache();
    this.API_URL = "https://api.dictionaryapi.dev/api/v2/entries/en";
    this.CACHE_KEY = "wordValidationCache";
    this.API_TIMEOUT = 3000; // 3 second timeout
  }

  /**
   * Load cached validation results from localStorage
   */
  loadCache() {
    try {
      const cached = localStorage.getItem(this.CACHE_KEY);
      return cached ? JSON.parse(cached) : {};
    } catch (e) {
      console.warn("Failed to load word cache:", e);
      return {};
    }
  }

  /**
   * Save cache to localStorage
   */
  saveCache() {
    try {
      localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.cache));
    } catch (e) {
      console.warn("Failed to save word cache:", e);
    }
  }

  /**
   * Main validation method with fallback chain:
   * 1. Check cache first (fastest)
   * 2. Query API (primary source)
   * 3. Fallback to backup list (safety net)
   */
  async isValidWord(word) {
    const upperWord = word.toUpperCase();

    // Step 1: Check cache first (instant response)
    if (upperWord in this.cache) {
      return this.cache[upperWord];
    }

    // Step 2: Query API with timeout
    try {
      const isValid = await this.checkApiWithTimeout(upperWord);
      this.cache[upperWord] = isValid;
      this.saveCache();
      return isValid;
    } catch (error) {
      console.warn(`API check failed for "${upperWord}":`, error.message);

      // Step 3: Fallback to backup list
      const isValidBackup = BACKUP_WORDS.has(upperWord);
      this.cache[upperWord] = isValidBackup; // Cache the fallback result
      this.saveCache();
      return isValidBackup;
    }
  }

  /**
   * Check word against Dictionary API with timeout protection
   */
  async checkApiWithTimeout(word) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), this.API_TIMEOUT);

    try {
      const response = await fetch(`${this.API_URL}/${word.toLowerCase()}`, {
        signal: controller.signal,
      });

      clearTimeout(timeoutId);

      if (response.ok) {
        return true; // Word exists in dictionary
      } else if (response.status === 404) {
        return false; // Word not found
      } else {
        throw new Error(`API returned status ${response.status}`);
      }
    } catch (error) {
      clearTimeout(timeoutId);
      throw error;
    }
  }

  /**
   * Clear cache if needed (useful for testing)
   */
  clearCache() {
    this.cache = {};
    try {
      localStorage.removeItem(this.CACHE_KEY);
    } catch (e) {
      console.warn("Failed to clear cache:", e);
    }
  }

  /**
   * Get cache stats for debugging
   */
  getCacheStats() {
    return {
      cachedWords: Object.keys(this.cache).length,
      backupWordsAvailable: BACKUP_WORDS.size,
      cacheSize: new Blob([JSON.stringify(this.cache)]).size,
    };
  }
}

// Create global instance
const dictionaryService = new DictionaryService();
